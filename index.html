<!DOCTYPE html>
<html>
  <head>
    <title>Ksatria Assignment - ThreeJS</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <link type="text/css" rel="stylesheet" href="/src/main.css" />
    <link type="text/css" rel="stylesheet" href="/src/ptable.css" />
    <link type="text/css" rel="stylesheet" href="/src/auth.css" />
  </head>

  <body>
    <!-- AUTH SCREEN -->
    <div id="auth-container">
      <div class="auth-card">
        <h1>Welcome Back</h1>
        <p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit</p>
        <div id="google-signin-container"></div>
      </div>
    </div>

    <!-- MAIN SCREEN -->
    <div id="app-container">
      <div id="info">
        <a href="https://threejs.org" target="_blank" rel="noopener"
          >three.js</a
        >
        css3d - periodic table.
      </div>

      <div id="container"></div>

      <div id="menu">
        <button id="table">TABLE</button>
        <button id="sphere">SPHERE</button>
        <button id="helix">HELIX</button>
        <button id="grid">GRID</button>
        <button id="logout">Log Out</button>
      </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "../build/three.module.js",
          "three/addons/": "./jsm/"
        }
      }
    </script>
    <script type="module">
      import { initApp } from "/src/main.js";

      // ----------
      // CONFIG
      // ----------
      const GOOGLE_CLIENT_ID = import.meta.env.VITE_CLIENT_ID;
      const STORAGE_KEY = "google_credential";

      // ----------
      // UI HANDLERS
      // ----------
      function showApp() {
        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.add("visible");
        document.getElementById("logout").addEventListener("click", logout);
        initApp();
      }

      // ----------
      // UI FUNCTIONS
      // ----------
      function logout() {
        localStorage.removeItem(STORAGE_KEY);
        google.accounts.id.disableAutoSelect();
        location.reload();
      }

      // ----------
      // TOKEN UTILS
      // ----------

      // Parse JWT token
      function parseJwt(token) {
        const base64Url = token.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      function isTokenExpired(token) {
        const payload = parseJwt(token);
        const now = Math.floor(Date.now() / 1000);
        return payload.exp < now;
      }

      // ----------
      // GOOGLE AUTH HANDLERS
      // ----------

      // Handle Google Sign-In Response
      function handleCredentialResponse(response) {
        const credential = response.credential;
        localStorage.setItem(STORAGE_KEY, credential);
        showApp();
      }

      // Initialize Google Sign-In
      window.onload = function () {
        const savedToken = localStorage.getItem(STORAGE_KEY);
        if (savedToken && !isTokenExpired(savedToken)) {
          showApp();
          return;
        }

        localStorage.removeItem(STORAGE_KEY);

        google.accounts.id.disableAutoSelect();

        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse,
          auto_select: false,
          auto_prompt: false,
        });

        // Render Google official button immediately
        // Apparently large size allow personalization but not medium or small
        // https://developers.google.com/identity/gsi/web/guides/personalized-button#:~:text=One%20session:%20There's%20only%20one,be%20displayed%20inside%20the%20button.
        const container = document.getElementById("google-signin-container");
        google.accounts.id.renderButton(
          document.getElementById("google-signin-container"),
          {
            type: "standard",
            theme: "filled_blue",
            size: "medium",
            shape: "rectangular",
            logo_alignment: "left",
            text: "signin_with",
            width: container.offsetWidth || 450
          }
        );
      };
    </script>
  </body>
</html>
